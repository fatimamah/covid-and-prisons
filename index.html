<!DOCTYPE html>
<meta charset="UTF-8">
<title>Project 2</title>
<script src="https://d3js.org/d3.v6.min.js"></script>
<script src="https://d3js.org/topojson.v3.min.js"></script>


<body>
  <h1> Project 2</h1>
  <script>

    const requestData = async function () {

      var prison_data = await d3.json("covid_prison_cases.json", d3.autoType);
      var prison_pops = await d3.json("prison2.json", d3.autoType);


      const formatMonthYear = d3.timeFormat('%b-%Y');


      prison_data.forEach((d, i) => {
        d["as_of_date"] = new Date(d["as_of_date"]);
        d["month_year"] = formatMonthYear(d["as_of_date"]);


      });

      prison_pops = prison_pops.filter((d) => { return  d["name"] != "Federal"; })
      prison_data = prison_data.filter((d) => { return d['total_prisoner_cases'] != null && d["as_of_date"].getFullYear() != 2021 && d["name"] != "Federal";; })

      //https://stackoverflow.com/questions/1129216/sort-array-of-objects-by-string-property-value
      //sorting alphabetically
      function compare( a, b ) {
          if ( a.name < b.name ){
            return -1;
          }
          if ( a.name > b.name ){
            return 1;
          }
          return 0;
        }
     var temp = prison_data.sort( compare );


      //totals
      //https://observablehq.com/@d3/d3-group
      var summed1 = d3.rollups(temp, v => d3.sum(v, d => d.total_prisoner_cases),  d => d.name, d => d.month_year)
                      //.sort(function(a,b) {return d3.ascending(a.name,b.month_year);});


      console.log(summed1);



  var pop = [];
  var prison;
  var state;

      summed1.forEach((d, i) => {
        var state = d[0];
        var outer_dic = {};
        var properties = {};
        outer_dic["id"] = i;
        properties["state"] = state;
        properties["id"] = i;

        var prison = prison_pops[i];

        var month_list = d[1];
        month_list.forEach((month, item) => {

        //march 2020
           if (month[0] == "Mar-2020") {
              properties[month[0]] = month[1]/prison.march_pop }
           else if (month[0] == "Apr-2020") {
               properties[month[0]] = month[1]/prison.april_pop }
           else if (month[0] == "May-2020") {
                properties[month[0]] = month[1]/prison.may_pop }
           else if (month[0] == "Jun-2020") {
                properties[month[0]] = month[1]/prison.june_pop }
           else if (month[0] == "Jul-2020") {
                properties[month[0]] = month[1]/prison.july_pop }
           else if (month[0] == "Aug-2020") {
                properties[month[0]] = month[1]/prison.aug_pop }
           else if (month[0] == "Sep-2020") {
               properties[month[0]] = month[1]/prison.sept_pop }
           else if (month[0] == "Oct-2020") {
               properties[month[0]] = month[1]/prison.oct_pop }
           else if (month[0] == "Nov-2020") {
               properties[month[0]] = month[1]/prison.nov_pop }
           else if (month[0] == "Dec-2020") {
             //console.log(state,month[1]);
              properties[month[0]] = month[1]/prison.dec_pop }
           else{
              console.log("missed something") }
        });

        outer_dic["properties"] = properties;
        pop.push(outer_dic);

      });
      //console.log(pop[10].properties);
      //console.log(prison_pops[10]);
      console.log(pop);


      var stateIDs = await d3.tsv("./us-state-names.tsv");

      //filter states not in our stateData from stateIDs
      stateIDs = stateIDs.filter((d) => {
        return d["name"] != "District of Columbia" && d["name"] != "America Samoa" && d["name"] != "Federated States of Micronesia" && d["name"] != "Palau" && d["name"] != "Guam" && d["name"] != "Marshall Islands" && d["name"] != "Northern Mariana Islands" && d["name"] != "Puerto Rico" && d["name"] != "U.S. Minor Outlying Islands" && d["name"] != "Virgin Islands of the United States";
      })

      let stateRates = {};
      let idToState = {}

      //set up stateCounts to take strings and for strings to be equal to state names and to match state ids with names in idToState
      stateIDs.forEach((row, i ) => {
        //console.log(row.id);
        //console.log(pop[row.id].properties);

        idToState[row.id] = row.name;
      });








    }

    requestData();

  </script>


</body>


</html>
