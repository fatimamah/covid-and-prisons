<!DOCTYPE html>
<meta charset="UTF-8">
<title>Project 2</title>
<script src="https://d3js.org/d3.v6.min.js"></script>
<script src="https://d3js.org/topojson.v3.min.js"></script>


<style>
  .outline {
    stroke: black;
    stroke-width: 1px;
    fill: none;
  }

  /* .graticule {
        fill: none;
        stroke: grey;
        stroke-width: 1px;
    } */

  .state {
    fill: lightgrey;
  }
</style>


<body>
  <h1> Project 2</h1>

  <svg id="usmap" height="600" width="900"></svg>

  <input type="range" id="slider" value="0" name="slider" min=0 max=9 step="1" />

  <label id="rangeText" />

  <script>

    function rangeValues(v) {

      if (v == 0) {
        return "March 2020"
      } else if (v == 1) {
        return "April 2020"
      } else if (v == 2) {
        return "May 2020"
      } else if (v == 3) {
        return "June 2020"
      } else if (v == 4) {
        return "July 2020"
      } else if (v == 5) {
        return "August 2020"
      } else if (v == 6) {
        return "September 2020"
      } else if (v == 7) {
        return "October 2020"
      } else if (v == 8) {
        return "November 2020"
      } else if (v == 9) {
        return "December 2020"
      }
    };

    onload = function () {
      var $ = function (id) { return document.getElementById(id); };
      // $('rangeText').text(rangeValues[$('slider').val()]);
      $('slider').oninput = function () {
        // $('rangeText').innerHTML = this.value;
        var text_label = rangeValues(this.value);
        $('rangeText').innerHTML = (text_label);
        //console.log($('range').innerHTML)

      };
      $('slider').oninput();
    };



    // $(function () {

    //   // on page load, set the text of the label based the value of the range
    //   $('#rangeText').text(rangeValues[$('#slider').val()]);

    //   // setup an event handler to set the text when the range value is dragged (see event for input) or changed (see event for change)
    //   $('#slider').on('input change', function () {
    //     $('#rangeText').text(rangeValues[$(this).val()]);
    //   });

    // });
  </script>


  <script>
    var value;
    var text2;
    const svg = d3.select("#usmap");
    const width = svg.attr("width");
    const height = svg.attr("height");
    const margin = { top: 20, right: 20, bottom: 20, left: 20 };
    const mapWidth = width - margin.left - margin.right;
    const mapHeight = height - margin.top - margin.bottom;


    var color = d3.scaleLinear().domain([0, 100]).range(["#add8e6", "#00264D"]);


    const map = svg.append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    const requestData = async function () {



      const us = await d3.json("us1.json");

      var states = topojson.feature(us, us.objects.states);
      var statesMesh = topojson.mesh(us, us.objects.states);

      var projection = d3.geoAlbersUsa().fitSize([mapWidth, mapHeight], states);
      var path = d3.geoPath().projection(projection);

      var graticule = d3.geoGraticule10();


      map.selectAll("path.state").data(states.features)
        .join("path")
        .attr("class", "state")
        .attr("stroke-width", "1px")
        .attr("stroke", "black")
        .attr("note", d => d.id)
        .attr("d", path);

      map.append("path").datum(state)
        .attr("class", "outline")
        .attr("d", path);



      var prison_data = await d3.json("covid_prison_cases.json", d3.autoType);
      var prison_pops = await d3.json("prison2.json", d3.autoType);


      const formatMonthYear = d3.timeFormat('%b-%Y');


      prison_data.forEach((d, i) => {
        d["as_of_date"] = new Date(d["as_of_date"]);
        d["month_year"] = formatMonthYear(d["as_of_date"]);


      });

      prison_pops = prison_pops.filter((d) => { return d["name"] != "Federal"; })
      prison_data = prison_data.filter((d) => { return d['total_prisoner_cases'] != null && d["as_of_date"].getFullYear() != 2021 && d["name"] != "Federal";; })


      var summed2 = d3.groups(prison_data, d => d.name, d => d.month_year, d => d.total_prisoner_cases)
      console.log(summed2);

      var pop = [];
      var prison;
      var state;

      var tryy = {}

      summed2.forEach((d, i) => {
        var state = d[0], prison = prison_pops[i];
        var outer_dic = {}, properties = {};
        outer_dic["id"] = i, properties["id"] = i;
        properties["state"] = state;


        var month_list = d[1];
        //console.log(month_list);

        var dec_count = [], nov_count = [], oct_count = [], sep_count = [], aug_count = [], jul_count = [], jun_count = [], may_count = [], apr_count = [], mar_count = [];

        var countsss = [];
        month_list.forEach((month, item) => {
          var week_list = month[1];

          week_list.forEach((week, index) => {
            if (month[0] == "Dec-2020") {
              //console.log(week[0], prison.dec_pop);
              var prop = (week[0] / prison.dec_pop);
              var temp = ((week[0] * 1.2) / (prison.dec_pop + week[0]))
              countsss.push(temp);
              dec_count.push(prop)
            }
            else if (month[0] == "Nov-2020") {
              var prop = (week[0] / prison.nov_pop);
              nov_count.push(prop)
            }
            else if (month[0] == "Oct-2020") {
              var prop = (week[0] / prison.oct_pop);
              oct_count.push(prop)
            }
            else if (month[0] == "Sep-2020") {
              var prop = (week[0] / prison.sept_pop);
              sep_count.push(prop)
            }
            else if (month[0] == "Aug-2020") {
              var prop = (week[0] / prison.aug_pop);
              aug_count.push(prop)
            }
            else if (month[0] == "Jul-2020") {
              var prop = (week[0] / prison.july_pop);
              jul_count.push(prop)
            }
            else if (month[0] == "Jun-2020") {
              var prop = (week[0] / prison.june_pop);
              jun_count.push(prop)
            }
            else if (month[0] == "May-2020") {
              var prop = (week[0] / prison.may_pop);
              may_count.push(prop)
            }
            else if (month[0] == "Apr-2020") {
              var prop = (week[0] / prison.april_pop);
              apr_count.push(prop)
            }
            else if (month[0] == "Mar-2020") {
              var prop = (week[0] / prison.march_pop);
              mar_count.push(prop)
            }
            else {
              console.log("wow");
            }


          });

        });

        var dec_mean = d3.mean(dec_count), nov_mean = d3.mean(nov_count), oct_mean = d3.mean(oct_count),
          sep_mean = d3.mean(sep_count), aug_mean = d3.mean(aug_count), jul_mean = d3.mean(jul_count),
          jun_mean = d3.mean(jun_count), may_mean = d3.mean(may_count), apr_mean = d3.mean(apr_count),
          mar_mean = d3.mean(mar_count);


        //console.log(d3.mean(countsss));




        for (k = 0; k < month_list.length; k++) {

          if (month_list[k][0] == "Dec-2020") {
            if (dec_mean <= 1) {
              properties["dec"] = dec_mean * 100;
            } else { properties["dec"] = null; }

          }
          else if (month_list[k][0] == "Nov-2020") {
            if (nov_mean <= 1) {
              properties["nov"] = nov_mean * 100;
            } else { properties["nov"] = null; }
          }
          else if (month_list[k][0] == "Oct-2020") {
            if (oct_mean <= 1) {
              properties["oct"] = oct_mean * 100;
            } else { properties["oct"] = null; }
          }
          else if (month_list[k][0] == "Sep-2020") {
            if (sep_mean <= 1) {
              properties["sep"] = sep_mean * 100;
            } else { properties["sep"] = null; }
          }
          else if (month_list[k][0] == "Aug-2020") {
            if (aug_mean <= 1) {
              properties["aug"] = aug_mean * 100;
            } else { properties["aug"] = null; }
          }
          else if (month_list[k][0] == "Jul-2020") {
            if (jul_mean <= 1) {
              properties["jul"] = jul_mean * 100;
            } else { properties["jul"] = null; }
          }
          else if (month_list[k][0] == "Jun-2020") {
            if (jun_mean <= 1) {
              properties["jun"] = jun_mean * 100;
            } else { properties["jun"] = null; }
          }
          else if (month_list[k][0] == "May-2020") {
            if (may_mean <= 1) {
              properties["may"] = may_mean * 100;
            } else { properties["may"] = null; }
          }
          else if (month_list[k][0] == "Apr-2020") {
            if (apr_mean <= 1) {
              properties["apr"] = apr_mean * 100;
            } else { properties["apr"] = null; }
          }
          else if (month_list[k][0] == "Mar-2020") {
            if (mar_mean <= 1) {
              properties["mar"] = mar_mean * 100;
            } else { properties["mar"] = null; }
          } else {
            console.log("seomthing bad");
          }



        };


        outer_dic["properties"] = properties;
        pop.push(outer_dic);
        tryy[state] = outer_dic;



      });

      console.log(tryy)

      var stateIDs = await d3.tsv("./us-state-names.tsv");

      stateIDs = stateIDs.filter((d) => {
        return d["name"] != "District of Columbia" && d["name"] != "America Samoa" && d["name"] != "Federated States of Micronesia" && d["name"] != "Palau" && d["name"] != "Guam" && d["name"] != "Marshall Islands" && d["name"] != "Northern Mariana Islands" && d["name"] != "Puerto Rico" && d["name"] != "U.S. Minor Outlying Islands" && d["name"] != "Virgin Islands of the United States";
      })

      let idToState = {}

      stateIDs.forEach((row, i) => {
        idToState[row.id] = row.name;
      });

      // console.log(tryy[idToState[56]]);

      function filler(a) {
        if (idToState[a]) {
          return color(tryy[idToState[a]].properties.nov)
        }
      }



      d3.selectAll("input").on("change", function change() {
        value = this.value;
        //console.log(value);
        text2 = 0;



        svg.selectAll(".state")
          .style("fill", function (d) {
            console.log(d.id)
            switch (value) {
              case "0":

                if (idToState[d.id]) {
                  text2 = "mar";
                  return color(tryy[idToState[d.id]].properties.mar);
                  break;
                } else { break; };
              case "1":
                if (idToState[d.id]) {
                  text2 = "apr"
                  return color(tryy[idToState[d.id]].properties.apr);
                  break;
                } else { break; };
              case "2":
                if (idToState[d.id]) {
                  text2 = "may"
                  return color(tryy[idToState[d.id]].properties.may);
                  break;
                } else { break; };
              case "3":
                if (idToState[d.id]) {
                  text2 = "jun"
                  return color(tryy[idToState[d.id]].properties.jun);
                  break;
                } else { break; };
              case "4":
                if (idToState[d.id]) {
                  text2 = "jul"
                  return color(tryy[idToState[d.id]].properties.jul);
                  break;
                } else { break; };
              case "5":
                if (idToState[d.id]) {
                  text2 = "aug"
                  return color(tryy[idToState[d.id]].properties.aug);
                  break;
                } else { break; };
              case "6":
                if (idToState[d.id]) {
                  text2 = "sep"
                  return color(tryy[idToState[d.id]].properties.sep);
                  break;
                } else { break; };
              case "7":
                if (idToState[d.id]) {
                  text2 = "oct"
                  return color(tryy[idToState[d.id]].properties.oct);
                  break;
                } else { break; };
              case "8":
                if (idToState[d.id]) {
                  text2 = "nov"
                  return color(tryy[idToState[d.id]].properties.nov);
                  break;
                } else { break; };
              case "9":
                if (idToState[d.id]) {
                  text2 = "dec"
                  return color(tryy[idToState[d.id]].properties.dec);
                  break;
                } else { break; };


              //return filler(g.id)

            }
          });
        //  d => {
        // if(idToState[d.id]) {
        //   return color(tryy[idToState[d.id]].properties.dec) }
        // });












      }


      )
      let tooltipWidth = 120;
      let tooltipHeight = 40;


      let tooltip = map.append("g")
        .attr("class", "tooltip")
        .attr("visibility", "hidden");
      rectangle = tooltip.append("rect")
        .attr("fill", "black")
        .attr("opacity", 0.9)
        .attr("x", -tooltipWidth / 2.0)
        .attr("y", 0)
        .attr("width", tooltipWidth)
        .attr("height", tooltipHeight)
      let txt = tooltip.append("text")
        .attr("fill", "white")
        .attr("text-anchor", "middle")
        .attr("alignment-baseline", "hanging")
        .attr("x", 0)
        .attr("y", 2);
      let txt2 = tooltip.append("text")
        .attr("fill", "white")
        .attr("text-anchor", "middle")
        .attr("alignment-baseline", "hanging")
        .attr("x", 0)
        .attr("y", 22);


      let momesh = map.append("path")
        .attr("class", "mouseover outline")
        .attr("d", "");


      d3.selectAll(".state").on("mouseenter", mouseEntersPlot);
      d3.selectAll(".state").on("mouseout", mouseLeavesPlot);


      function mouseEntersPlot() {
        // Make tooltip visible
        tooltip.style("visibility", "visible")

        // Find the state SVG element and add stroke
        let state = d3.select(this);
        let stateID = state.datum().id;
        // console.log(state.datum())

        var mo = topojson.mesh(us, us.objects.states, function (a, b) { return a.id === stateID || b.id === stateID; });
        momesh.datum(mo).attr("d", path)



        // value = this.value;
        // txt2.text(gen_rates[idToState[stateID]].properties.dec)

        var label2 = tryy[idToState[stateID]].properties[text2]

        if (label2 != null) {
          txt
            .attr("visibility", "visible")
          txt.text(idToState[stateID]);
          var label2_formatted = label2.toFixed(2) + "%"
          txt2.text(label2_formatted)
            .attr("text-anchor", "middle")
            .attr("alignment-baseline", "hanging")
            .attr("x", 0)

          rectangle
            .attr("width", tooltipWidth)
        }
        else {

          rectangle
            .attr("width", 160)
          txt
            .attr("visibility", "hidden")
          txt2.text("State Data not Available")
            .attr("text-anchor", "middle")
            .attr("alignment-baseline", "middle")
            .attr("x", 20)

        }

        let bounds = path.bounds(state.datum())
        let xPos = (bounds[0][0] + bounds[1][0]) / 2.0;
        let yPos = bounds[1][1];
        tooltip.attr("transform", `translate(${xPos},${yPos})`);
      }

      function mouseLeavesPlot() {
        tooltip.style("visibility", "hidden");

        let state = d3.select(this);
        momesh.attr("d", "");

      }
    };

    requestData();

  </script>


</body>


</html>